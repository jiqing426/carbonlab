# 资源库同步功能说明

## 功能概述

本功能实现了将本地资源库管理系统（`http://localhost:3000/dashboard/resources`）的数据同步到 Tale 平台资源管理系统（`https://tale.turinhub.com/dashboard/resources`）。**以本地数据为准**，将本地资源库信息推送到 Tale 平台，确保 Tale 平台显示与本地一致的数据。

## 主要特性

### 1. 单向同步（以本地为准）
- **推送到 Tale**：将本地资源库数据同步到 Tale 平台
- **检查一致性**：检查 Tale 平台数据与本地数据的一致性
- **不修改本地数据**：始终保持本地数据不变
- **数据一致性检查**：检测并报告数据不一致问题

### 2. 自动同步
- 创建资源库时自动同步到 Tale 平台
- 编辑资源库信息时自动更新 Tale 平台
- 删除资源库时自动删除 Tale 平台文件夹

### 3. 手动同步
- 提供单个资源库手动同步功能
- 支持同步所有资源库到 Tale 平台
- 支持检查 Tale 平台数据一致性
- 实时显示同步状态和结果

### 4. 同步状态管理
- **已同步** ✅：资源库已成功同步到 Tale 平台
- **待同步** ⏳：资源库创建但未同步
- **同步失败** ❌：同步过程中出现错误
- **未同步** ☁️：资源库未尝试同步

## 技术实现

### 1. 核心服务
- **ResourceSyncService** (`lib/services/resource-sync-service.ts`)
  - 封装所有同步逻辑
  - 处理 API 调用和数据转换
  - 管理同步状态和错误处理

### 2. 数据映射
- **本地资源库** → **Tale 文件夹**
  - `folderName` → `folderName`
  - `folderType` → `folderType`
  - `remark` → `remark`（包含控制目标信息）
  - `folderAttr` → `folderAttr`

### 3. 同步流程
1. **推送同步**：本地 → Tale 平台
   - 检查资源库是否已同步（通过 `taleFolderId`）
   - 如果已同步：更新现有文件夹
   - 如果未同步：创建新文件夹
   - 更新本地同步状态

2. **拉取同步**：Tale 平台 → 本地
   - 获取 Tale 平台所有文件夹
   - 解析文件夹信息为资源库格式
   - 智能合并本地和远程数据
   - 保存到本地存储

3. **双向同步**：推送 + 拉取
   - 先推送本地变更到 Tale 平台
   - 再拉取远程数据合并到本地
   - 确保数据完全一致

### 4. 数据一致性检查
- 比较本地和远程资源库数量
- 检查本地资源库是否在远程存在
- 检查远程资源库是否在本地存在
- 报告不一致的详细信息

## 使用方法

### 1. 自动同步
资源库的创建、编辑、删除操作会自动触发同步：

```typescript
// 创建资源库时自动同步
const newRepository = {
  // ... 资源库数据
  syncStatus: 'pending'
};

// 自动同步到 Tale 平台
const syncResult = await resourceSyncService.syncRepositoryToTale(newRepository);
```

### 2. 手动同步
提供多种手动同步选项：

```typescript
// 同步单个资源库
await resourceSyncService.syncRepositoryToTale(repository);

// 双向同步所有资源库
await resourceSyncService.syncBidirectional();

// 检查数据一致性
await resourceSyncService.checkDataConsistency();
```

### 3. UI 操作
- **双向同步按钮**：执行完整的双向同步
- **检查一致性按钮**：验证数据一致性
- **单个同步按钮**：同步特定资源库
- **同步状态显示**：实时显示同步状态

## 错误处理

### 1. 网络错误
- API 调用失败时显示错误信息
- 自动重试机制（可配置）
- 降级处理：本地操作继续，同步标记为失败

### 2. 数据错误
- 数据格式验证
- 必填字段检查
- 类型转换错误处理

### 3. 同步冲突
- 智能合并策略
- 冲突检测和报告
- 用户手动解决选项

## 配置说明

### 1. API 配置
```typescript
const API_BASE_URL = process.env.NEXT_PUBLIC_TALE_BACKEND_URL || 'https://api.turingue.com';
const APP_KEY = 'oa_HBamFxnA'; // 应用密钥
```

### 2. 同步配置
- 批量同步延迟：500ms（避免 API 限制）
- 重试次数：3 次
- 超时时间：30 秒

## 测试

### 1. 测试页面
访问 `/test-resource-sync` 进行功能测试：
- 创建测试资源库
- 获取文件夹列表
- 双向同步测试
- 数据一致性检查

### 2. 测试用例
- 正常同步流程
- 网络错误处理
- 数据冲突解决
- 批量操作性能

## 注意事项

### 1. 数据安全
- 所有操作都有错误处理
- 本地数据优先保护
- 同步失败不影响本地操作

### 2. 性能考虑
- 批量操作有延迟控制
- 大量数据分批处理
- 异步操作不阻塞 UI

### 3. 用户体验
- 实时状态反馈
- 清晰的操作提示
- 详细的错误信息

## 未来扩展

### 1. 功能增强
- 增量同步支持
- 冲突解决界面
- 同步历史记录
- 批量操作优化

### 2. 性能优化
- 缓存机制
- 并发控制
- 数据压缩
- 断点续传

### 3. 监控告警
- 同步状态监控
- 错误率统计
- 性能指标收集
- 自动告警通知
